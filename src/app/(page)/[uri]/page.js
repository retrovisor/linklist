import { Page } from "@/models/Page";
import { User } from "@/models/User";
import { Event } from "@/models/Event";
import {
  faDiscord,
  faFacebook,
  faGithub,
  faInstagram,
  faTelegram,
  faTiktok,
  faWhatsapp,
  faYoutube
} from "@fortawesome/free-brands-svg-icons";
import { faEnvelope, faLink, faLocationDot, faMobile, faPhone } from "@fortawesome/free-solid-svg-icons";
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome";
import mongoose from "mongoose";
import { btoa } from "next/dist/compiled/@edge-runtime/primitives";
import Image from "next/image";
import Link from "next/link";
import "@/styles/template1.css";
import "@/styles/template2.css";

export const buttonsIcons = {
  email: faEnvelope,
  mobile: faPhone,
  instagram: faInstagram,
  facebook: faFacebook,
  discord: faDiscord,
  tiktok: faTiktok,
  youtube: faYoutube,
  whatsapp: faWhatsapp,
  github: faGithub,
  telegram: faTelegram,
};

function buttonLink(key, value) {
  if (key === 'mobile') {
    return 'tel:' + value;
  }
  if (key === 'email') {
    return 'mailto:' + value;
  }
  return value;
}

export default async function UserPage({ params }) {
  const uri = params.uri;

  await mongoose.connect(process.env.MONGO_URI);

  const page = await Page.findOne({ uri });

  if (!page) {
    console.log("Page not found for URI:", uri);
    return <div>Page not found</div>;
  }

  const user = await User.findOne({ email: page.owner });

  if (!user) {
    console.log("User not found for email:", page.owner);
    return <div>User not found</div>;
  }

  await Event.create({ uri: uri, page: uri, type: 'view' });

  const template = page.template || "template1"; // Default to template1 if not specified

  return (
    <div className={`text-white min-h-screen template ${template}`} style={
          page.bgType === 'color'
            ? { backgroundColor: page.bgColor }
            : { backgroundImage: `url(${page.bgImage})` }
        }>
      <div
        className="h-32 bg-cover bg-center"></div>


          <div className="logo-container">
 
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="396" height="97">
<path d="M0 0 C130.68 0 261.36 0 396 0 C396 32.01 396 64.02 396 97 C265.32 97 134.64 97 0 97 C0 64.99 0 32.98 0 0 Z " fill="#FCFCFC" transform="translate(0,0)"/>
<path d="M0 0 C2.02165045 1.79708961 2.89978782 3.27526422 3.2718811 5.96624756 C3.38187475 8.49038622 3.38919539 10.9970001 3.36328125 13.5234375 C3.36402901 14.93008163 3.36402901 14.93008163 3.36479187 16.36514282 C3.3624515 18.35396436 3.35272515 20.34278886 3.33618164 22.33154297 C3.31285496 25.32938181 3.31558823 28.3263138 3.32226562 31.32421875 C3.30755459 40.77160763 3.0264131 49.89236463 1.46118164 59.22363281 C0.73520071 63.59412257 0.61049476 67.9318951 0.44140625 72.35546875 C0 75 0 75 -1.36328125 76.8515625 C-3 78 -3 78 -5.75 78.1875 C-14.7680518 74.89244261 -18.83814777 64.15546256 -22.8125 56.125 C-28.26837196 45.25145354 -34.03792903 34.60308242 -40 24 C-40.00142502 24.57549591 -40.00285004 25.15099182 -40.00431824 25.743927 C-40.02404127 31.7467585 -40.07837033 37.74857668 -40.15258789 43.75097656 C-40.17575071 45.98950932 -40.19015955 48.22815079 -40.19555664 50.46679688 C-40.20485837 53.68948989 -40.24587802 56.91047701 -40.29296875 60.1328125 C-40.28706978 61.62846237 -40.28706978 61.62846237 -40.28105164 63.15432739 C-40.37531927 67.66791315 -40.49928065 71.00986388 -43.3371582 74.65576172 C-46 77 -46 77 -49.3125 77.375 C-50.6428125 77.189375 -50.6428125 77.189375 -52 77 C-57.4464078 69.64734947 -57.78068018 62.95551688 -57 54 C-56.83326782 53.37711594 -56.66653564 52.75423187 -56.49475098 52.11247253 C-55.93240037 49.71136517 -55.8465259 47.52945514 -55.81054688 45.0637207 C-55.78547058 43.59749016 -55.78547058 43.59749016 -55.7598877 42.10163879 C-55.74631226 41.0536058 -55.73273682 40.00557281 -55.71875 38.92578125 C-55.70034058 37.84620651 -55.68193115 36.76663177 -55.66296387 35.65434265 C-55.58424195 31.03325337 -55.51631179 26.41202106 -55.44775391 21.79077148 C-55.39619029 18.41903102 -55.3388981 15.04742226 -55.28125 11.67578125 C-55.26767456 10.62167557 -55.25409912 9.56756989 -55.2401123 8.48152161 C-55.22339478 7.51349106 -55.20667725 6.54546051 -55.18945312 5.5480957 C-55.17692505 4.6919014 -55.16439697 3.83570709 -55.15148926 2.9535675 C-55 1 -55 1 -54 0 C-49.19605606 -0.68627771 -46.67392984 0.5092391 -42.84179688 3.36816406 C-39.50088088 6.32822272 -37.08240782 9.90330883 -34.5625 13.5625 C-33.99901855 14.36171875 -33.43553711 15.1609375 -32.85498047 15.984375 C-29.0778529 21.36572567 -25.39626224 26.80933257 -21.78125 32.30078125 C-19.92334789 35.11615485 -18.03748279 37.90891332 -16.125 40.6875 C-15.29355469 41.89986328 -15.29355469 41.89986328 -14.4453125 43.13671875 C-13.12311095 45.118709 -13.12311095 45.118709 -11 46 C-11.02094727 44.85523193 -11.04189453 43.71046387 -11.06347656 42.53100586 C-11.13617801 38.26144037 -11.18190879 33.99192901 -11.21972656 29.72192383 C-11.23977361 27.87808006 -11.2670188 26.03429932 -11.30175781 24.19067383 C-11.35058208 21.5319051 -11.37303772 18.87398085 -11.390625 16.21484375 C-11.41127014 15.39789536 -11.43191528 14.58094696 -11.45318604 13.73924255 C-11.45540104 8.01866166 -10.30509663 4.69912217 -7 0 C-4.24438552 -1.37780724 -2.90228766 -0.92023755 0 0 Z " fill="#050505" transform="translate(64,10)"/>
<path d="M0 0 C2.8125 1.6875 2.8125 1.6875 5 4 C5.63671875 6.64453125 5.63671875 6.64453125 6 9 C6.82242187 8.3503125 7.64484375 7.700625 8.4921875 7.03125 C19.59293704 -1.40785773 19.59293704 -1.40785773 26.91015625 -0.61328125 C30.5082351 0.44260357 31.91822411 1.90887823 34 5 C37.4845171 12.4140399 37.53752958 20.00266115 37.6875 28.0625 C37.72166016 29.30966797 37.75582031 30.55683594 37.79101562 31.84179688 C37.87288731 34.89444127 37.94223628 37.94682034 38 41 C39.32 41 40.64 41 42 41 C41.46625282 47.93871329 38.23525362 53.6529837 33.5 58.625 C31 60 31 60 28.375 60 C25.40367441 58.74891554 24.50273186 57.85519053 23 55 C22.10901575 49.99713898 21.81732633 45.0540355 21.71875 39.984375 C21.70034058 39.24672913 21.68193115 38.50908325 21.66296387 37.74908447 C21.58492752 34.62224575 21.51634661 31.49522225 21.44775391 28.36816406 C21.39601152 26.0734606 21.33881405 23.77893862 21.28125 21.484375 C21.26767456 20.77810974 21.25409912 20.07184448 21.2401123 19.34417725 C21.16297844 16.3087273 20.96738717 13.90216151 20 11 C17.75775342 10.41036322 17.75775342 10.41036322 15 11 C10.92315346 14.62819836 8.25307205 18.20853113 7.75048828 23.75219727 C7.69103027 24.84588623 7.63157227 25.9395752 7.5703125 27.06640625 C7.49683594 28.27490234 7.42335938 29.48339844 7.34765625 30.72851562 C7.2008272 33.2568088 7.06006394 35.78546256 6.92578125 38.31445312 C5.80909444 56.19090556 5.80909444 56.19090556 2 60 C-1.80298815 60.51858929 -3.48986643 60.3549889 -6.67480469 58.13867188 C-10.0313504 53.60782857 -9.61428374 49.89955367 -9.453125 44.40625 C-9.44367859 43.38196899 -9.43423218 42.35768799 -9.42449951 41.30236816 C-9.38995319 38.03409955 -9.32119289 34.76765728 -9.25 31.5 C-9.19997634 28.2325892 -9.15699337 24.96519606 -9.11834717 21.69763184 C-9.09202435 19.66634139 -9.05786923 17.63513361 -9.01495361 15.60412598 C-8.99063263 14.21743713 -8.99063263 14.21743713 -8.96582031 12.80273438 C-8.94851868 11.99396851 -8.93121704 11.18520264 -8.91339111 10.35192871 C-9.0069502 7.81126223 -9.43957646 5.47625171 -10 3 C-6.69711045 -0.04882113 -4.45440141 -0.63634306 0 0 Z " fill="#050505" transform="translate(293,28)"/>
<path d="M0 0 C4.16726465 4.06041171 5.6083988 7.74334187 5.765625 13.5 C5.75630443 15.4584843 5.72953681 17.41694471 5.6875 19.375 C5.67106445 20.90072632 5.67106445 20.90072632 5.65429688 22.45727539 C5.5424299 30.12198699 5.17817477 37.74340462 4.4375 45.375 C5.38625 44.55 6.335 43.725 7.3125 42.875 C10.1875 40.375 10.1875 40.375 12.4375 40.375 C12.9325 39.385 12.9325 39.385 13.4375 38.375 C14.4375 39.375 14.4375 39.375 14.8125 42.5 C14.34838857 47.29581806 12.68685756 49.90596756 9.4375 53.375 C5.68702518 55.87531654 3.87893734 55.91103554 -0.5625 55.375 C-2.26836575 53.74847684 -3.9402546 52.08493434 -5.5625 50.375 C-8.71080592 50.67906174 -10.45450758 51.92862782 -12.8125 53.9375 C-15.95988352 56.2393178 -18.48772815 57.1370224 -22.5078125 56.86328125 C-27.4331864 55.69280266 -31.19300342 52.87288688 -34.5625 49.1875 C-36.56893795 43.54439326 -36.1367809 38.21874394 -34.375 32.5625 C-28.82584867 22.80364766 -18.62005713 19.13346081 -8.5625 15.375 C-8.2325 12.405 -7.9025 9.435 -7.5625 6.375 C-12.38635337 7.30418487 -17.18637811 8.24498667 -21.9375 9.5 C-25.5625 10.375 -25.5625 10.375 -29.5625 10.375 C-29.48471339 7.65246874 -29.13465386 5.9313485 -27.1484375 4 C-19.24231929 -1.85122405 -9.24152487 -4.2154324 0 0 Z " fill="#0A0A0A" transform="translate(113.5625,29.625)"/>
<path d="M0 0 C2.14576637 -0.02685938 4.29162645 -0.04633088 6.4375 -0.0625 C7.63246094 -0.07410156 8.82742188 -0.08570313 10.05859375 -0.09765625 C13 0 13 0 14 1 C14.15996166 3.59153107 14.25938697 6.1595202 14.31640625 8.75390625 C14.33718735 9.52935287 14.35796844 10.3047995 14.37937927 11.10374451 C14.44495802 13.58990308 14.50379799 16.07617045 14.5625 18.5625 C14.60567733 20.24415204 14.64929136 21.92579294 14.69335938 23.60742188 C14.80064779 27.73816871 14.90189132 31.86902536 15 36 C15.48355957 35.64172119 15.96711914 35.28344238 16.46533203 34.91430664 C18.6770184 33.28554741 20.90071658 31.67400797 23.125 30.0625 C23.88554687 29.49853516 24.64609375 28.93457031 25.4296875 28.35351562 C29.5494791 25.38797598 32.74410655 23.12664803 38 23 C40.375 23.9375 40.375 23.9375 42 25 C40.45409201 29.09713039 37.51017914 31.34828509 34.1875 34 C33.66607422 34.42539062 33.14464844 34.85078125 32.60742188 35.2890625 C31.07802797 36.53396241 29.53910939 37.76713189 28 39 C27.08863281 39.763125 26.17726563 40.52625 25.23828125 41.3125 C23 43 23 43 21 43 C23.11957015 47.37161344 26.03455202 49.89767378 29.66796875 52.96484375 C43.70124728 65.21164126 43.70124728 65.21164126 44.375 71.5 C44 75 44 75 42.3125 76.9375 C39.4393216 78.25760899 38.14548974 78.5041707 35 78 C32.60193324 76.26205125 30.6435918 74.15783561 28.625 72 C28.05426758 71.41001221 27.48353516 70.82002441 26.89550781 70.2121582 C23.18990009 66.35417134 19.59620643 62.40386168 16.171875 58.29296875 C15.78515625 57.86628906 15.3984375 57.43960938 15 57 C14.67 57 14.34 57 14 57 C13.34 62.28 12.68 67.56 12 73 C11.34 73 10.68 73 10 73 C10 73.66 10 74.32 10 75 C9.34 75 8.68 75 8 75 C7.67 75.99 7.34 76.98 7 78 C4.0625 77.1875 4.0625 77.1875 1 76 C-0.17727453 72.46817642 -0.11994258 69.68663738 -0.11352539 65.95825195 C-0.11367142 65.24580322 -0.11381744 64.53335449 -0.1139679 63.79931641 C-0.11327151 61.445607 -0.10549192 59.09197683 -0.09765625 56.73828125 C-0.0957911 55.10589135 -0.09436765 53.47350089 -0.09336853 51.84111023 C-0.08955101 47.54538425 -0.07972724 43.24969211 -0.06866455 38.95397949 C-0.05843399 34.57023577 -0.05386738 30.18648659 -0.04882812 25.80273438 C-0.0381043 17.2018074 -0.02103705 8.60090791 0 0 Z " fill="#050505" transform="translate(344,8)"/>
<path d="M0 0 C2.99894847 1.68829692 4.08078353 2.88131314 5.109375 6.1875 C5.65382007 9.33381938 5.77860993 12.05296374 5.109375 15.1875 C-0.1343644 21.59651482 -9.8584055 24.95483265 -17.890625 26.1875 C-20.22364486 26.22574623 -22.55774008 26.23324284 -24.890625 26.1875 C-24.22776069 31.16770425 -23.540969 35.805519 -21.390625 40.375 C-18.08487015 42.77167227 -15.84658219 42.8786582 -11.8203125 42.6875 C-6.20369647 41.72893086 -1.094524 39.43820337 4.109375 37.1875 C5.77417079 36.51617504 7.44016711 35.84777817 9.109375 35.1875 C8.02302142 40.79408343 4.57767993 45.22954042 0.14453125 48.74609375 C-6.50194053 53.04525112 -12.93908827 55.25400493 -20.890625 54.1875 C-27.03791958 52.31755793 -31.53058848 48.63054981 -34.890625 43.1875 C-38.94353467 34.50050872 -39.52643707 24.01645858 -36.453125 14.9375 C-33.00953439 7.46624688 -26.50294935 1.03186637 -18.9140625 -2.22265625 C-12.17581716 -4.18689379 -6.30092104 -2.8178032 0 0 Z " fill="#070707" transform="translate(170.890625,30.8125)"/>
<path d="M0 0 C3.7538853 0.03381879 6.80692596 0.78527039 10.3125 2.1875 C10.49576245 9.49409413 9.85622816 16.59945723 9.08706665 23.86276245 C7.67184698 37.29136219 6.72329774 50.68783625 6.3125 64.1875 C9.51098983 62.34795404 12.35875639 60.44080318 15.125 58 C15.72957031 57.47019531 16.33414063 56.94039062 16.95703125 56.39453125 C17.40433594 55.99621094 17.85164063 55.59789062 18.3125 55.1875 C17.74759351 62.81373766 16.21341788 70.95791124 10.375 76.375 C7.3125 78.1875 7.3125 78.1875 4.75 78.3125 C1.41402914 76.77282114 -0.38176245 75.05409263 -2.6875 72.1875 C-4.30010488 67.52706254 -4.93668426 63.45010853 -4.93041992 58.53369141 C-4.93349655 57.25611969 -4.93657318 55.97854797 -4.93974304 54.66226196 C-4.93284847 53.28786027 -4.92558175 51.9134604 -4.91796875 50.5390625 C-4.91677523 49.1165674 -4.91632415 47.6940715 -4.9165802 46.27157593 C-4.91502279 43.30453492 -4.90678545 40.33761584 -4.89331055 37.37060547 C-4.87622846 33.56058329 -4.87249925 29.75069359 -4.87325573 25.94063759 C-4.87298457 23.01023079 -4.86751355 20.07985315 -4.86025429 17.14945602 C-4.85706631 15.74357702 -4.85509991 14.33769471 -4.85436058 12.93181229 C-4.85220367 10.9761766 -4.84267622 9.02055316 -4.83276367 7.06494141 C-4.82895187 5.95132233 -4.82514008 4.83770325 -4.82121277 3.69033813 C-4.60803554 -0.29991726 -4.17631655 0.21235508 0 0 Z " fill="#040404" transform="translate(234.6875,7.8125)"/>
<path d="M0 0 C1.20849609 -0.00386719 1.20849609 -0.00386719 2.44140625 -0.0078125 C4.4375 0.125 4.4375 0.125 5.4375 1.125 C5.54635129 2.65813087 5.58654164 4.19621166 5.59863281 5.7331543 C5.60824036 6.71475021 5.6178479 7.69634613 5.62774658 8.70768738 C5.63199646 9.77739273 5.63624634 10.84709808 5.640625 11.94921875 C5.64632507 13.04337601 5.65202515 14.13753326 5.65789795 15.2648468 C5.66736716 17.58760608 5.67388952 19.9103789 5.67773438 22.2331543 C5.6874114 25.7800262 5.71840545 29.32631185 5.75 32.87304688 C5.75653259 35.12760072 5.76178205 37.38215872 5.765625 39.63671875 C5.7779718 40.69630295 5.7903186 41.75588715 5.80303955 42.84757996 C5.78615694 48.45818823 5.51989391 52.37068715 2.4375 57.125 C-4.3125 56.375 -4.3125 56.375 -6.5625 54.125 C-6.80300903 51.87240601 -6.80300903 51.87240601 -6.78955078 49.03271484 C-6.78932419 47.44129166 -6.78932419 47.44129166 -6.78909302 45.81771851 C-6.77360916 44.09423691 -6.77360916 44.09423691 -6.7578125 42.3359375 C-6.7549826 41.16237701 -6.75215271 39.98881653 -6.74923706 38.7796936 C-6.73801355 35.01969338 -6.71290492 31.25992861 -6.6875 27.5 C-6.67747301 24.9557326 -6.66834668 22.41146148 -6.66015625 19.8671875 C-6.63806714 13.6197109 -6.60456824 7.37237227 -6.5625 1.125 C-4.1828388 -0.0648306 -2.64764265 -0.00849966 0 0 Z " fill="#0A0A0A" transform="translate(266.5625,28.875)"/>
<path d="M0 0 C3.16041435 2.88559571 4.76419058 4.84453384 5.625 9.0625 C4.76204427 13.11839195 3.30616302 14.53796371 0 17 C-3.5 18.125 -3.5 18.125 -7 18 C-10.32311591 15.61602555 -11.699152 13.84945316 -13.0625 10 C-12.9804394 6.06109122 -11.74448544 4.74448544 -9 2 C-5.47427193 -0.35048538 -4.14986355 -0.66397817 0 0 Z " fill="#080808" transform="translate(207,70)"/>
<path d="M0 0 C1.21067812 12.1235962 1.21067812 12.1235962 -1.60546875 16.48828125 C-4.59156039 19.19425172 -6.61311763 20.88392615 -10.70703125 21.2265625 C-13 21 -13 21 -14 20 C-14.62154125 15.45252099 -15.03470777 10.91100751 -12.80078125 6.78515625 C-9.02167616 2.28259528 -6.02444596 0 0 0 Z " fill="#FBFBFB" transform="translate(106,55)"/>
<path d="M0 0 C1.9375 1.0625 1.9375 1.0625 3 3 C3.5 6.375 3.5 6.375 3 10 C0.66081464 13.14119177 -0.73229726 14.75853281 -4.625 15.5 C-7.45388774 14.90444469 -8.23233885 14.24975055 -10 12 C-10.3984375 9.84375 -10.3984375 9.84375 -10.375 7.5 C-10.38273437 6.7265625 -10.39046875 5.953125 -10.3984375 5.15625 C-9.3305481 -0.62291619 -5.10780837 -0.54726518 0 0 Z " fill="#0C0C0C" transform="translate(270,5)"/>
<path d="M0 0 C2 2 2 2 2.02734375 3.953125 C0.40173797 7.19197455 -2.10810615 7.56848455 -5.4375 8.75 C-6.61183594 9.17796875 -7.78617188 9.6059375 -8.99609375 10.046875 C-12 11 -12 11 -14 11 C-13.91811241 8.2158219 -13.39519212 6.46615204 -11.5859375 4.33203125 C-7.85719183 0.87431775 -5.29588649 -0.98528121 0 0 Z " fill="#EDEDED" transform="translate(162,38)"/>
</svg>

          </div>
          
      <div className="aspect-square w-24 h-24 mx-auto relative -top-16 -mb-12">
        <Image
          className="rounded-full w-full h-full object-cover"
          src={user.image}
          alt="avatar"
          width={90} height={90}
        />
      </div>
      <h2 className="text-2xl text-center mb-1">{page.displayName}</h2>
      <h3 className="text-md flex gap-2 justify-center items-center text-white/70">
        <FontAwesomeIcon className="h-4" icon={faLocationDot} />
        <span>{page.location}</span>
      </h3>
    
      <div className="flex gap-2 justify-center mt-4 pb-4">
        {Object.keys(page.buttons).map(buttonKey => (
          <Link key={buttonKey} href={buttonLink(buttonKey, page.buttons[buttonKey])}
                className="rounded-full bg-white text-blue-950 p-2 flex items-center justify-center">
            <FontAwesomeIcon className="w-5 h-5" icon={buttonsIcons[buttonKey]} />
          </Link>
        ))}
      </div>

            <div className="max-w-xs mx-auto text-center my-2">
        <p>{page.bio}</p>
      </div>
      <div className="max-w-2xl mx-auto p-4 px-4">
        {page.links.map(link => (
          <Link
            key={link.url}
            target="_blank"
            ping={process.env.URL + 'api/click?url=' + btoa(link.url) + '&page=' + page.uri}
            className="bg-white border-slate-950 border-2 shadow-lg mb-4 p-2 block flex"
            href={link.url}>
            <div className="relative overflow-hidden w-16">
              <div className="w-16 h-16 bg-blue-700 aspect-square relative flex items-center justify-center aspect-square">
                {link.icon && (
                  <Image
                    className="w-full h-full object-cover"
                    src={link.icon}
                    alt={'icon'} width={64} height={64} />
                )}
                {!link.icon && (
                  <FontAwesomeIcon icon={faLink} className="w-8 h-8" />
                )}
              </div>
            </div>
            <div className="flex items-center justify-center shrink grow-0 overflow-hidden ml-4">
              <div>
                <h3 className="text-black text-xl font-semibold">{link.title}</h3>
                <p className="text-white/50 h-6 overflow-hidden">{link.subtitle}</p>
              </div>
            </div>
          </Link>
        ))}
      </div>
    </div>
  );
}
